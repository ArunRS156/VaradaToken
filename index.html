<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family:sans-serif; background:#FFF5EC; padding:10px; }
.card { background:#fff; border-radius:12px; max-width:400px; margin:auto;
       border-top:6px solid #E67E22; box-shadow:0 4px 10px rgba(0,0,0,.1); }
input, select { width:100%; padding:12px; margin:8px 0; border:1px solid #ccc; border-radius:6px; }
.p-box { display:grid; grid-template-columns:repeat(3,1fr); gap:5px; }
.p-btn { padding:10px; border:1px solid #ddd; border-radius:6px; background:#fff; }
.p-btn.active { background:#D35400; color:#fff; }
.btn { width:100%; padding:15px; border:none; border-radius:6px; font-weight:bold; color:#fff; }
.hidden { display:none; }
</style>
</head>
<body>

<div id="loading" class="card" style="padding:40px;text-align:center;">
  Checking slots…
</div>

<div id="closed" class="card hidden" style="padding:40px;text-align:center;color:red;">
  ALL SLOTS FULL
</div>

<div id="form" class="card hidden">
  <div style="background:#D35400;color:white;padding:15px;text-align:center;">
    Project Arun
  </div>
  <div style="padding:20px;">
    <label>Name</label><input id="name">

    <label>Persons</label>
    <div class="p-box">
      <button class="p-btn" onclick="setP('1',this)">1</button>
      <button class="p-btn" onclick="setP('2',this)">2</button>
      <button class="p-btn" onclick="setP('3',this)">3</button>
      <button class="p-btn" onclick="setP('4',this)">4</button>
      <button class="p-btn" onclick="setP('5',this)">5</button>
      <button class="p-btn" onclick="setP('5+',this)">5+</button>
    </div>

    <input type="checkbox" id="nonKA" onchange="toggleLoc()"> Outside Karnataka?

    <div id="ka">
      <select id="dist">
        <option>Bengaluru</option>
        <option>Mysuru</option>
      </select>
    </div>

    <div id="nka" class="hidden">
      <select id="state">
        <option>Tamil Nadu</option>
        <option>Kerala</option>
      </select>
    </div>

    <label>Place</label><input id="place">
    <label>Mobile</label><input id="mobile" maxlength="10">

    <a class="btn" style="background:#27AE60;text-decoration:none;text-align:center;"
       href="upi://pay?pa=ajvinay991@mvhdfc&pn=Arun&am=0.01"
       onclick="pay()">Pay ₹1 & Register</a>
  </div>
</div>

<div id="payCheck" class="card hidden" style="padding:30px;text-align:center;position:relative;">
  <span onclick="closePayCheck()" style="position:absolute;top:10px;right:15px;cursor:pointer;font-weight:bold;">✖</span>
  <h3>Payment Check</h3>
  <p>Was your payment successful?</p>
  <button class="btn" style="background:#27AE60;margin-bottom:10px;" onclick="confirmYes()">Yes, Proceed</button>
  <button class="btn" style="background:#E74C3C;" onclick="confirmNo()">No, Try Again</button>
</div>

<div id="upScr" class="card hidden" style="padding:20px;text-align:center;">
  <h3>Enter Transaction ID</h3>
  <input id="txnId" placeholder="Transaction ID">
  <button class="btn" style="background:#27AE60;margin-bottom:10px;" onclick="saveTxn()">Save Transaction ID</button>

  <hr style="margin:15px 0">

  <h3>Upload Screenshot</h3>
  <input type="file" id="file" accept="image/*">
  <button class="btn" style="background:#27AE60;" onclick="upload()">Submit Proof</button>
</div>

<div id="tokenScr" class="card hidden" style="padding:30px;text-align:center;">
  <h3 style="color:green;">Your Token</h3>
  <div id="tDisp" style="border:2px dashed #D35400;padding:15px;font-weight:bold;"></div>
</div>

<script>
const loading = document.getElementById("loading");
const closed  = document.getElementById("closed");
const form    = document.getElementById("form");
const payCheck = document.getElementById("payCheck");
const upScr    = document.getElementById("upScr");
const tokenScr = document.getElementById("tokenScr");

const name = document.getElementById("name");
const mobile = document.getElementById("mobile");
const place = document.getElementById("place");
const dist = document.getElementById("dist");
const state = document.getElementById("state");
const nonKA = document.getElementById("nonKA");
const file = document.getElementById("file");
const txnId = document.getElementById("txnId");
const tDisp = document.getElementById("tDisp");

let pCount = "", paymentPending = false;

window.onload = () => {
  google.script.run.withSuccessHandler(s => {
    loading.classList.add("hidden");
    s === "FULL" ? closed.classList.remove("hidden") : form.classList.remove("hidden");
  }).getLimitStatus();
};

function setP(v,b){
  pCount=v;
  document.querySelectorAll('.p-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
}

function toggleLoc(){
  nonKA.checked
    ? (ka.classList.add('hidden'), nka.classList.remove('hidden'))
    : (ka.classList.remove('hidden'), nka.classList.add('hidden'));
}

function validate(){
  if(!name.value || !pCount || !place.value) return alert("All fields required"), false;
  if(!/^[6-9]\d{9}$/.test(mobile.value)) return alert("Invalid mobile"), false;
  return true;
}

function pay(){
  if(!validate()) return;
  form.classList.add("hidden");
  payCheck.classList.remove("hidden");
  paymentPending = true;
}

function closePayCheck(){
  payCheck.classList.add("hidden");
  form.classList.remove("hidden");
  paymentPending=false;
}

function confirmNo(){
  window.location.href = "upi://pay?pa=ajvinay991@mvhdfc&pn=Arun&am=0.01";
}

function confirmYes(){
  payCheck.classList.add("hidden");
  paymentPending=false;
  submit();
}

window.addEventListener("focus",()=>{ if(paymentPending) payCheck.classList.remove("hidden"); });

function submit(){
  google.script.run.withSuccessHandler(()=>{
    upScr.classList.remove("hidden");
  }).verifyAndSubmit({
    name: name.value.trim(),
    mobile: mobile.value.trim(),
    persons: pCount,
    isNonKA: nonKA.checked,
    district: dist.value,
    state: state.value,
    place: place.value.trim()
  });
}

function saveTxn(){
  if(!txnId.value.trim()) return alert("Transaction ID required");
  google.script.run.saveTxnId(mobile.value.trim(), txnId.value.trim());
}

function upload(){
  const f = file.files[0];
  if(!f) return alert("Select screenshot");

  const r = new FileReader();
  r.onload = e => {
    google.script.run.withSuccessHandler(res=>{
      if(res.status==="txn_missing") return alert("Enter Transaction ID first");
      if(res.status==="success"){
        tDisp.innerText = res.token;
        upScr.classList.add("hidden");
        tokenScr.classList.remove("hidden");
      }
    }).uploadScreenshot({
      base64: e.target.result.split(',')[1],
      type: f.type,
      mobile: mobile.value.trim()
    });
  };
  r.readAsDataURL(f);
}
</script>
</body>
</html>
